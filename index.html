<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Hub - Search + RAG + MCP + Salesforce</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background: #0078d4;
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 { font-size: 18px; font-weight: 600; }
        .header-left p { font-size: 11px; opacity: 0.8; margin-top: 2px; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }
        .header-btn:hover { background: rgba(255,255,255,0.25); }
        .header-btn.active { background: rgba(255,255,255,0.35); }

        /* Tab styles */
        .tabs {
            display: flex;
            background: #005a9e;
        }
        .tab {
            padding: 10px 20px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }
        .tab:hover { color: white; }
        .tab.active { color: white; border-bottom-color: white; }
        .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
        .tab-content.active { display: flex; }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }
        .message { margin-bottom: 16px; display: flex; flex-direction: column; }
        .message.user { align-items: flex-end; }
        .message.agent { align-items: flex-start; }
        .message-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            line-height: 1.5;
        }
        .message.user .message-bubble {
            background: #0078d4;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.agent .message-bubble {
            background: white;
            color: #333;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .message-label { font-size: 11px; color: #666; margin-bottom: 4px; padding: 0 8px; }

        .sources, .rag-sources {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }
        .sources-title { color: #666; margin-bottom: 4px; font-weight: 500; }
        .sources a, .rag-sources span {
            display: block;
            color: #0078d4;
            text-decoration: none;
            padding: 2px 0;
        }
        .sources a:hover { text-decoration: underline; }
        .rag-sources span {
            color: #5c6bc0;
            cursor: default;
        }
        .rag-sources span::before {
            content: "üìÑ ";
        }

        .input-container {
            background: white;
            border-top: 1px solid #ddd;
            padding: 16px 20px;
        }
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }
        input[type="text"] {
            flex: 1;
            padding: 12px 16px;
            font-size: 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
        }
        input[type="text"]:focus { border-color: #0078d4; }
        button {
            padding: 12px 24px;
            font-size: 15px;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
        }
        button:hover { background: #106ebe; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; }
        .typing-indicator span {
            width: 8px; height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }

        .welcome { text-align: center; padding: 40px 20px; color: #666; }
        .welcome h2 { color: #333; margin-bottom: 10px; }
        .welcome p { margin-bottom: 20px; }
        .suggestions { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; }
        .suggestion {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .suggestion:hover { border-color: #0078d4; color: #0078d4; }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal h2 { margin-bottom: 16px; }
        .modal-close {
            float: right;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            color: #666;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-area:hover { border-color: #0078d4; background: #f8f9fa; }
        .upload-area.dragover { border-color: #0078d4; background: #e3f2fd; }
        .upload-area input { display: none; }
        .upload-status { margin-top: 16px; font-size: 14px; }
        .upload-status.success { color: #4caf50; }
        .upload-status.error { color: #f44336; }
        .doc-list { margin-top: 20px; }
        .doc-list h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .doc-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .doc-item-name { font-size: 14px; }
        .doc-item-delete {
            background: #ff5252;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .rag-indicator {
            background: #e8f5e9;
            color: #2e7d32;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        /* Research tab styles */
        .research-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .research-input-container {
            background: white;
            border-top: 1px solid #ddd;
            padding: 16px 20px;
        }
        .company-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .company-card h3 {
            color: #0078d4;
            margin-bottom: 12px;
            font-size: 20px;
        }
        .company-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        .company-info-item {
            background: #f5f7fa;
            padding: 10px;
            border-radius: 6px;
        }
        .company-info-item label {
            display: block;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .company-info-item span {
            font-size: 14px;
            color: #333;
        }
        .company-description {
            color: #555;
            line-height: 1.6;
            border-top: 1px solid #eee;
            padding-top: 16px;
        }
        .workflow-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976d2;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .research-welcome {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .research-welcome h2 { color: #333; margin-bottom: 12px; }
        .research-welcome p { margin-bottom: 8px; }
        .step-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .step {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #999;
        }
        .step.active { color: #0078d4; }
        .step.complete { color: #4caf50; }
        .step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .step.active .step-number { background: #0078d4; color: white; }
        .step.complete .step-number { background: #4caf50; color: white; }

        /* MCP styles */
        .mcp-indicator {
            background: #fff3e0;
            color: #e65100;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .mcp-tools-used {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
            font-size: 12px;
        }
        .mcp-tools-used .sources-title { color: #e65100; }
        .mcp-tool-item {
            background: #fff3e0;
            padding: 4px 8px;
            border-radius: 4px;
            margin: 4px 0;
            font-family: monospace;
            font-size: 11px;
        }
        .mcp-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .mcp-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
        }
        .mcp-status-dot.connected { background: #4caf50; }
        .mcp-status-dot.disconnected { background: #f44336; }
        .mcp-server-list {
            margin-top: 16px;
        }
        .mcp-server-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .mcp-server-info { flex: 1; }
        .mcp-server-name { font-weight: 600; color: #333; }
        .mcp-server-tools { font-size: 12px; color: #666; margin-top: 4px; }
        .mcp-connect-form {
            display: grid;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }
        .mcp-connect-form input {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .mcp-connect-form button {
            padding: 10px 16px;
            border-radius: 6px;
        }

        /* Salesforce styles */
        .sf-indicator {
            background: #e1f5fe;
            color: #0277bd;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .sf-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sf-status-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        .sf-status-icon.connected { background: #e8f5e9; }
        .sf-status-icon.disconnected { background: #ffebee; }
        .sf-status-info { flex: 1; }
        .sf-status-title { font-weight: 600; color: #333; }
        .sf-status-details { font-size: 13px; color: #666; margin-top: 4px; }
        .sf-results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sf-results-table th {
            background: #1976d2;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
        }
        .sf-results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .sf-results-table tr:hover td {
            background: #f5f5f5;
        }
        .sf-query-info {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        .sf-query-info strong { color: #333; }
        .sf-examples {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }
        .sf-example {
            background: white;
            padding: 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }
        .sf-example:hover {
            border-color: #1976d2;
            box-shadow: 0 2px 8px rgba(25,118,210,0.2);
        }
        .sf-example-title { font-weight: 500; color: #1976d2; margin-bottom: 4px; }
        .sf-example-desc { font-size: 12px; color: #666; }
        .sf-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .sf-toggle label { font-size: 13px; color: #666; }
        .sf-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>AI Agent Hub</h1>
            <p>Search + RAG + MCP + Salesforce</p>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="openMCPModal()">üîå MCP</button>
            <button class="header-btn" onclick="openDocModal()">üìÑ Documents</button>
            <button class="header-btn" onclick="clearChat()">Clear</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('chat')">üí¨ Chat Agent</button>
        <button class="tab" onclick="switchTab('salesforce')">‚òÅÔ∏è Salesforce</button>
        <button class="tab" onclick="switchTab('research')">üîç Research</button>
        <button class="tab" onclick="switchTab('mcp')">üîå MCP</button>
    </div>

    <!-- Chat Tab -->
    <div class="tab-content active" id="chatTab">
        <div class="chat-container" id="chatContainer">
        <div class="welcome" id="welcome">
            <h2>Hello! I'm your Search Agent</h2>
            <p>I can search the web AND your uploaded documents. Try asking:</p>
            <div class="suggestions">
                <span class="suggestion" onclick="sendSuggestion('Elon Musk')">Elon Musk</span>
                <span class="suggestion" onclick="sendSuggestion('What is in my documents?')">My documents</span>
                <span class="suggestion" onclick="sendSuggestion('Latest AI news')">Latest AI news</span>
            </div>
        </div>
    </div>

        <div class="input-container">
            <form class="input-wrapper" id="chatForm">
                <input type="text" id="messageInput" placeholder="Ask anything..." autocomplete="off" required>
                <button type="submit" id="sendBtn">Send</button>
            </form>
        </div>
    </div>

    <!-- Salesforce Tab -->
    <div class="tab-content" id="salesforceTab">
        <div class="research-container" id="sfContainer">
            <h2 style="margin-bottom:8px;">‚òÅÔ∏è Salesforce Query Agent</h2>
            <p style="color:#666;margin-bottom:20px;">Query your Salesforce data using natural language. No SOQL knowledge required!</p>

            <div class="sf-status" id="sfStatus">
                <div class="sf-status-icon disconnected" id="sfStatusIcon">‚òÅÔ∏è</div>
                <div class="sf-status-info">
                    <div class="sf-status-title" id="sfStatusTitle">Checking connection...</div>
                    <div class="sf-status-details" id="sfStatusDetails">Verifying Salesforce credentials</div>
                </div>
            </div>

            <div class="sf-toggle">
                <input type="checkbox" id="sfUseAI">
                <label for="sfUseAI">Use AI for complex queries (slower but handles sophisticated requests)</label>
            </div>

            <div id="sfResultsArea">
                <div class="sf-examples">
                    <div class="sf-example" onclick="runSFQuery('show all accounts')">
                        <div class="sf-example-title">Show Accounts</div>
                        <div class="sf-example-desc">List all accounts with basic info</div>
                    </div>
                    <div class="sf-example" onclick="runSFQuery('open opportunities')">
                        <div class="sf-example-title">Open Opportunities</div>
                        <div class="sf-example-desc">View deals in progress</div>
                    </div>
                    <div class="sf-example" onclick="runSFQuery('pipeline forecast')">
                        <div class="sf-example-title">Pipeline Forecast</div>
                        <div class="sf-example-desc">See opportunity stages summary</div>
                    </div>
                    <div class="sf-example" onclick="runSFQuery('new leads')">
                        <div class="sf-example-title">Recent Leads</div>
                        <div class="sf-example-desc">Show newly created leads</div>
                    </div>
                    <div class="sf-example" onclick="runSFQuery('contacts at Acme')">
                        <div class="sf-example-title">Find Contacts</div>
                        <div class="sf-example-desc">Search contacts by company</div>
                    </div>
                    <div class="sf-example" onclick="runSFQuery('deals closing this month')">
                        <div class="sf-example-title">Closing This Month</div>
                        <div class="sf-example-desc">Opportunities closing soon</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="research-input-container">
            <form class="input-wrapper" id="sfForm">
                <input type="text" id="sfInput" placeholder="Ask about your Salesforce data... (e.g., 'show all accounts', 'open opportunities')" autocomplete="off" required>
                <button type="submit" id="sfBtn">Query</button>
            </form>
        </div>
    </div>

    <!-- Research Tab -->
    <div class="tab-content" id="researchTab">
        <div class="research-container" id="researchContainer">
            <div class="research-welcome" id="researchWelcome">
                <h2>üîç Company Research Agent</h2>
                <p>Powered by OpenAI Agent Builder Workflow</p>
                <div class="workflow-badge">wf_69692eed96408190ae45fa67ca337c22087d366e89592a85</div>
                <p style="margin-top:20px;color:#333;">Enter a company name to research:</p>
                <div class="suggestions" style="margin-top:12px;">
                    <span class="suggestion" onclick="runResearch('Microsoft')">Microsoft</span>
                    <span class="suggestion" onclick="runResearch('Tesla')">Tesla</span>
                    <span class="suggestion" onclick="runResearch('OpenAI')">OpenAI</span>
                </div>
            </div>
        </div>
        <div class="research-input-container">
            <form class="input-wrapper" id="researchForm">
                <input type="text" id="researchInput" placeholder="Enter company name to research..." autocomplete="off" required>
                <button type="submit" id="researchBtn">Research</button>
            </form>
        </div>
    </div>

    <!-- MCP Tab -->
    <div class="tab-content" id="mcpTab">
        <div class="research-container">
            <h2 style="margin-bottom:8px;">üîå MCP - Model Context Protocol</h2>
            <p style="color:#666;margin-bottom:20px;">Connect to external MCP servers to extend your agent's capabilities with additional tools.</p>

            <div class="mcp-status" id="mcpStatus">
                <span class="mcp-status-dot" id="mcpStatusDot"></span>
                <span id="mcpStatusText">Loading...</span>
            </div>

            <div class="mcp-server-list" id="mcpServerList">
                <!-- Server list will be populated here -->
            </div>

            <div class="mcp-connect-form">
                <h3 style="margin-bottom:8px;">Connect to MCP Server</h3>
                <input type="text" id="mcpServerName" placeholder="Server name (e.g., filesystem)">
                <input type="text" id="mcpServerCommand" placeholder="Command (e.g., npx)">
                <input type="text" id="mcpServerArgs" placeholder="Arguments (comma-separated, e.g., -y,@modelcontextprotocol/server-filesystem,/path)">
                <button onclick="connectMCPServer()">Connect Server</button>
            </div>

            <div style="margin-top:24px;padding:16px;background:#e3f2fd;border-radius:8px;">
                <h4 style="color:#1976d2;margin-bottom:8px;">What is MCP?</h4>
                <p style="font-size:13px;color:#333;line-height:1.6;">
                    Model Context Protocol (MCP) is Anthropic's open standard for connecting AI models to external data sources and tools.
                    Once connected, MCP servers provide tools that your Chat Agent can use automatically.
                </p>
                <p style="font-size:13px;color:#666;margin-top:12px;">
                    <strong>Example servers:</strong><br>
                    ‚Ä¢ <code>@modelcontextprotocol/server-filesystem</code> - File system access<br>
                    ‚Ä¢ <code>@modelcontextprotocol/server-github</code> - GitHub integration<br>
                    ‚Ä¢ <code>@modelcontextprotocol/server-slack</code> - Slack messaging
                </p>
            </div>
        </div>
    </div>

    <!-- Document Upload Modal -->
    <div class="modal-overlay" id="docModal">
        <div class="modal">
            <button class="modal-close" onclick="closeDocModal()">&times;</button>
            <h2>üìÑ Document Management</h2>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" accept=".txt,.md,.csv">
                <p>üì§ Drop text files here<br><small>.txt, .md, .csv supported</small></p>
            </div>
            <div class="upload-status" id="uploadStatus"></div>
            <div class="doc-list" id="docList">
                <h3>Uploaded Documents</h3>
                <div id="docItems">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let chatHistory = [];
        const chatContainer = document.getElementById('chatContainer');
        const form = document.getElementById('chatForm');
        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');

        // Chat functions
        function sendSuggestion(text) {
            input.value = text;
            form.dispatchEvent(new Event('submit'));
        }

        function clearChat() {
            chatHistory = [];
            chatContainer.innerHTML = `
                <div class="welcome" id="welcome">
                    <h2>Hello! I'm your Search Agent</h2>
                    <p>I can search the web AND your uploaded documents. Try asking:</p>
                    <div class="suggestions">
                        <span class="suggestion" onclick="sendSuggestion('Elon Musk')">Elon Musk</span>
                        <span class="suggestion" onclick="sendSuggestion('What is in my documents?')">My documents</span>
                        <span class="suggestion" onclick="sendSuggestion('Latest AI news')">Latest AI news</span>
                    </div>
                </div>`;
        }

        function addMessage(role, content, sources = [], ragSources = [], ragUsed = false, mcpToolsUsed = []) {
            const welcomeEl = document.getElementById('welcome');
            if (welcomeEl) welcomeEl.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let sourcesHtml = '';
            if (sources.length > 0) {
                sourcesHtml = `
                    <div class="sources">
                        <div class="sources-title">üåê Web Sources:</div>
                        ${sources.map((s, i) => `<a href="${s.url}" target="_blank">[${i + 1}] ${s.title}</a>`).join('')}
                    </div>`;
            }

            let ragSourcesHtml = '';
            if (ragSources.length > 0) {
                const uniqueFiles = [...new Set(ragSources.map(s => s.filename))];
                ragSourcesHtml = `
                    <div class="rag-sources">
                        <div class="sources-title">üìÑ Documents Used:</div>
                        ${uniqueFiles.map(f => `<span>${f}</span>`).join('')}
                    </div>`;
            }

            let ragIndicator = ragUsed ? '<span class="rag-indicator">RAG</span>' : '';
            let mcpIndicator = mcpToolsUsed && mcpToolsUsed.length > 0 ? '<span class="mcp-indicator">MCP</span>' : '';

            let mcpToolsHtml = '';
            if (mcpToolsUsed && mcpToolsUsed.length > 0) {
                mcpToolsHtml = `
                    <div class="mcp-tools-used">
                        <div class="sources-title">üîå MCP Tools Used:</div>
                        ${mcpToolsUsed.map(t => `<div class="mcp-tool-item">${t.tool}</div>`).join('')}
                    </div>`;
            }

            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            messageDiv.innerHTML = `
                <span class="message-label">${role === 'user' ? 'You' : 'Agent'}${ragIndicator}${mcpIndicator}</span>
                <div class="message-bubble">
                    ${formattedContent}
                    ${mcpToolsHtml}
                    ${ragSourcesHtml}
                    ${sourcesHtml}
                </div>`;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message agent';
            typingDiv.id = 'typing';
            typingDiv.innerHTML = `
                <span class="message-label">Agent</span>
                <div class="message-bubble">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>`;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';
            sendBtn.disabled = true;
            chatHistory.push({ role: 'user', content: message });
            showTyping();

            try {
                const response = await fetch('/api/hello', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, chatHistory })
                });

                const data = await response.json();
                hideTyping();

                if (!response.ok) throw new Error(data.error || 'Request failed');

                addMessage('agent', data.message, data.sources || [], data.ragSources || [], data.ragUsed, data.mcpToolsUsed || []);
                chatHistory.push({ role: 'assistant', content: data.message });

            } catch (error) {
                hideTyping();
                addMessage('agent', `Sorry, an error occurred: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        });

        // Document modal functions
        function openDocModal() {
            document.getElementById('docModal').classList.add('active');
            loadDocuments();
        }

        function closeDocModal() {
            document.getElementById('docModal').classList.remove('active');
        }

        async function loadDocuments() {
            const docItems = document.getElementById('docItems');
            try {
                const response = await fetch('/api/upload?op=list');
                const data = await response.json();

                if (data.documents && data.documents.length > 0) {
                    docItems.innerHTML = data.documents.map(doc => `
                        <div class="doc-item">
                            <span class="doc-item-name">üìÑ ${doc.filename}</span>
                            <button class="doc-item-delete" onclick="deleteDocument('${doc.filename}')">Delete</button>
                        </div>
                    `).join('');
                } else {
                    docItems.innerHTML = '<p style="color:#999;font-size:14px;">No documents uploaded yet</p>';
                }
            } catch (error) {
                docItems.innerHTML = '<p style="color:#f44336;font-size:14px;">Failed to load documents</p>';
            }
        }

        async function deleteDocument(filename) {
            if (!confirm(`Delete "${filename}"?`)) return;

            try {
                const response = await fetch(`/api/upload?op=delete&filename=${encodeURIComponent(filename)}`);
                const data = await response.json();
                if (data.success) {
                    loadDocuments();
                }
            } catch (error) {
                alert('Failed to delete document');
            }
        }

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) uploadFile(files[0]);
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) uploadFile(fileInput.files[0]);
        });

        async function uploadFile(file) {
            // Check file type
            const allowedTypes = ['.txt', '.md', '.csv'];
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();

            if (!allowedTypes.includes(fileExt)) {
                uploadStatus.textContent = `‚úó Only text files supported (.txt, .md, .csv)`;
                uploadStatus.className = 'upload-status error';
                return;
            }

            uploadStatus.textContent = `Uploading ${file.name}...`;
            uploadStatus.className = 'upload-status';

            try {
                // Read as text
                const text = await file.text();
                const response = await fetch('/api/upload?op=upload', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: text, filename: file.name })
                });

                const data = await response.json();

                if (response.ok) {
                    uploadStatus.textContent = `‚úì ${data.message}`;
                    uploadStatus.className = 'upload-status success';
                    loadDocuments();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                uploadStatus.textContent = `‚úó Upload failed: ${error.message}`;
                uploadStatus.className = 'upload-status error';
            }

            fileInput.value = '';
        }

        input.focus();

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tabName === 'chat') {
                document.querySelector('.tab:nth-child(1)').classList.add('active');
                document.getElementById('chatTab').classList.add('active');
                input.focus();
            } else if (tabName === 'salesforce') {
                document.querySelector('.tab:nth-child(2)').classList.add('active');
                document.getElementById('salesforceTab').classList.add('active');
                document.getElementById('sfInput').focus();
                loadSFStatus();
            } else if (tabName === 'research') {
                document.querySelector('.tab:nth-child(3)').classList.add('active');
                document.getElementById('researchTab').classList.add('active');
                document.getElementById('researchInput').focus();
            } else if (tabName === 'mcp') {
                document.querySelector('.tab:nth-child(4)').classList.add('active');
                document.getElementById('mcpTab').classList.add('active');
                loadMCPStatus();
            }
        }

        // MCP functions
        function openMCPModal() {
            switchTab('mcp');
        }

        async function loadMCPStatus() {
            const statusDot = document.getElementById('mcpStatusDot');
            const statusText = document.getElementById('mcpStatusText');
            const serverList = document.getElementById('mcpServerList');

            try {
                const response = await fetch('/api/mcp');
                const data = await response.json();

                const toolCount = data.toolCount || 0;
                const servers = Object.keys(data.status || {});

                if (servers.length > 0) {
                    statusDot.className = 'mcp-status-dot connected';
                    statusText.textContent = `${servers.length} server(s) connected, ${toolCount} tools available`;

                    serverList.innerHTML = servers.map(name => {
                        const server = data.status[name];
                        return `
                            <div class="mcp-server-item">
                                <div class="mcp-server-info">
                                    <div class="mcp-server-name">${name}</div>
                                    <div class="mcp-server-tools">${server.toolCount} tools ‚Ä¢ ${server.connected ? 'Connected' : 'Disconnected'}</div>
                                </div>
                                <span class="mcp-status-dot ${server.connected ? 'connected' : 'disconnected'}"></span>
                            </div>
                        `;
                    }).join('');

                    // Show tools
                    if (data.tools && data.tools.length > 0) {
                        serverList.innerHTML += `
                            <div style="margin-top:16px;">
                                <h4 style="color:#666;margin-bottom:8px;">Available Tools</h4>
                                ${data.tools.map(t => `
                                    <div class="mcp-tool-item" style="margin:4px 0;">${t.name} - ${t.description || 'No description'}</div>
                                `).join('')}
                            </div>
                        `;
                    }
                } else {
                    statusDot.className = 'mcp-status-dot disconnected';
                    statusText.textContent = 'No MCP servers connected';
                    serverList.innerHTML = '<p style="color:#999;font-size:14px;">Connect an MCP server to extend your agent with external tools.</p>';
                }
            } catch (error) {
                statusDot.className = 'mcp-status-dot disconnected';
                statusText.textContent = 'Failed to load MCP status';
                serverList.innerHTML = `<p style="color:#f44336;font-size:14px;">Error: ${error.message}</p>`;
            }
        }

        async function connectMCPServer() {
            const name = document.getElementById('mcpServerName').value.trim();
            const command = document.getElementById('mcpServerCommand').value.trim();
            const argsStr = document.getElementById('mcpServerArgs').value.trim();

            if (!name || !command) {
                alert('Server name and command are required');
                return;
            }

            const args = argsStr ? argsStr.split(',').map(a => a.trim()) : [];

            try {
                const response = await fetch('/api/mcp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'connect',
                        server: { name, command, args }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    alert(`Connected to ${name}! ${data.tools?.length || 0} tools available.`);
                    document.getElementById('mcpServerName').value = '';
                    document.getElementById('mcpServerCommand').value = '';
                    document.getElementById('mcpServerArgs').value = '';
                    loadMCPStatus();
                } else {
                    alert(`Failed to connect: ${data.error}`);
                }
            } catch (error) {
                alert(`Connection error: ${error.message}`);
            }
        }

        // Salesforce functions
        const sfForm = document.getElementById('sfForm');
        const sfInput = document.getElementById('sfInput');
        const sfBtn = document.getElementById('sfBtn');
        const sfResultsArea = document.getElementById('sfResultsArea');

        async function loadSFStatus() {
            const icon = document.getElementById('sfStatusIcon');
            const title = document.getElementById('sfStatusTitle');
            const details = document.getElementById('sfStatusDetails');

            try {
                const response = await fetch('/api/salesforce?action=status');
                const data = await response.json();

                if (data.connected) {
                    icon.className = 'sf-status-icon connected';
                    title.textContent = 'Connected to Salesforce';
                    details.textContent = data.organization?.Name
                        ? `Organization: ${data.organization.Name}`
                        : data.instanceUrl;
                } else {
                    icon.className = 'sf-status-icon disconnected';
                    title.textContent = 'Salesforce Not Connected';
                    details.textContent = 'Configure SALESFORCE_INSTANCE_URL and SALESFORCE_ACCESS_TOKEN';
                }
            } catch (error) {
                icon.className = 'sf-status-icon disconnected';
                title.textContent = 'Connection Error';
                details.textContent = error.message;
            }
        }

        function runSFQuery(query) {
            sfInput.value = query;
            sfForm.dispatchEvent(new Event('submit'));
        }

        function displaySFResults(data) {
            let html = '';

            if (data.soql) {
                html += `
                    <div class="sf-query-info">
                        <strong>SOQL:</strong> ${data.soql}<br>
                        <strong>Records:</strong> ${data.totalRecords}
                        ${data.conversion?.aiGenerated ? ' <span class="sf-indicator">AI Generated</span>' : ''}
                    </div>
                `;
            }

            if (data.records && data.records.length > 0) {
                // Get all unique keys from records
                const keys = [...new Set(data.records.flatMap(r => Object.keys(r)))];

                html += `<table class="sf-results-table">`;
                html += `<thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead>`;
                html += `<tbody>`;

                for (const record of data.records) {
                    html += '<tr>';
                    for (const key of keys) {
                        let value = record[key];
                        if (value && typeof value === 'object') {
                            value = value.Name || JSON.stringify(value);
                        }
                        html += `<td>${value ?? ''}</td>`;
                    }
                    html += '</tr>';
                }

                html += '</tbody></table>';
            } else {
                html += '<p style="text-align:center;color:#666;padding:40px;">No records found</p>';
            }

            sfResultsArea.innerHTML = html;
        }

        sfForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = sfInput.value.trim();
            if (!query) return;

            sfBtn.disabled = true;
            sfResultsArea.innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div class="typing-indicator" style="justify-content:center;">
                        <span></span><span></span><span></span>
                    </div>
                    <p style="color:#666;margin-top:16px;">Querying Salesforce...</p>
                </div>
            `;

            try {
                const useAI = document.getElementById('sfUseAI').checked;
                const response = await fetch('/api/salesforce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, useAI })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Query failed');
                }

                displaySFResults(data);

            } catch (error) {
                sfResultsArea.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#f44336;">
                        <p>Query failed: ${error.message}</p>
                        ${error.message.includes('not configured') ? `
                            <p style="font-size:13px;color:#666;margin-top:12px;">
                                Set environment variables:<br>
                                SALESFORCE_INSTANCE_URL<br>
                                SALESFORCE_ACCESS_TOKEN
                            </p>
                        ` : ''}
                    </div>
                `;
            } finally {
                sfBtn.disabled = false;
            }
        });

        // Research Agent functionality
        const researchForm = document.getElementById('researchForm');
        const researchInput = document.getElementById('researchInput');
        const researchBtn = document.getElementById('researchBtn');
        const researchContainer = document.getElementById('researchContainer');

        function runResearch(query) {
            researchInput.value = query;
            researchForm.dispatchEvent(new Event('submit'));
        }

        function showResearchProgress() {
            const welcome = document.getElementById('researchWelcome');
            if (welcome) welcome.style.display = 'none';

            researchContainer.innerHTML = `
                <div style="text-align:center;padding:40px;">
                    <div class="step-indicator">
                        <div class="step active" id="step1">
                            <span class="step-number">1</span>
                            <span>Web Research Agent</span>
                        </div>
                        <div class="step" id="step2">
                            <span class="step-number">2</span>
                            <span>Summarize & Display</span>
                        </div>
                    </div>
                    <div class="typing-indicator" style="justify-content:center;margin-top:30px;">
                        <span></span><span></span><span></span>
                    </div>
                    <p style="color:#666;margin-top:20px;">Researching company information...</p>
                </div>
            `;
        }

        function displayResearchResults(data) {
            let html = `
                <div class="workflow-badge" style="margin-bottom:20px;">
                    Workflow: ${data.workflowId}
                </div>
            `;

            if (data.companies && data.companies.length > 0) {
                for (const company of data.companies) {
                    html += `
                        <div class="company-card">
                            <h3>${company.company_name}</h3>
                            <div class="company-info">
                                <div class="company-info-item">
                                    <label>Industry</label>
                                    <span>${company.industry}</span>
                                </div>
                                <div class="company-info-item">
                                    <label>Headquarters</label>
                                    <span>${company.headquarters_location}</span>
                                </div>
                                <div class="company-info-item">
                                    <label>Company Size</label>
                                    <span>${company.company_size}</span>
                                </div>
                                <div class="company-info-item">
                                    <label>Website</label>
                                    <span><a href="${company.website}" target="_blank">${company.website}</a></span>
                                </div>
                                <div class="company-info-item">
                                    <label>Founded</label>
                                    <span>${company.founded_year}</span>
                                </div>
                            </div>
                            <div class="company-description">
                                ${company.description}
                            </div>
                        </div>
                    `;
                }
            } else {
                html += `<p style="color:#666;text-align:center;">No company information found.</p>`;
            }

            researchContainer.innerHTML = html;
        }

        researchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = researchInput.value.trim();
            if (!query) return;

            researchBtn.disabled = true;
            showResearchProgress();

            try {
                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Research failed');
                }

                displayResearchResults(data);

            } catch (error) {
                researchContainer.innerHTML = `
                    <div style="text-align:center;padding:40px;color:#f44336;">
                        <p>Research failed: ${error.message}</p>
                        <button class="header-btn" style="background:#0078d4;margin-top:20px;" onclick="location.reload()">Try Again</button>
                    </div>
                `;
            } finally {
                researchBtn.disabled = false;
                researchInput.value = '';
            }
        });
    </script>
</body>
</html>
